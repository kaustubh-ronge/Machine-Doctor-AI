// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================
// 1. ENUMS (Constants)
// ==============================

enum Role {
  USER
  ADMIN
}

enum PlanTier {
  FREE
  STANDARD
  PRO
}

enum SubmissionType {
  FILE_UPLOAD
  MANUAL_ENTRY
}

enum ProcessingStatus {
  PENDING    // Waiting for AI
  PROCESSING // AI is working
  COMPLETED  // Result ready
  FAILED     // Error occurred
}

enum RiskLevel {
  LOW
  MODERATE
  HIGH
  CRITICAL
}

// ==============================
// 2. USER MANAGEMENT
// ==============================

model User {
  id        String   @id // Stores the Clerk User ID (e.g., user_2bX...)
  email     String   @unique
  firstName String?
  lastName  String?
  imageUrl  String?
  
  role      Role     @default(USER)
  
  // --- USAGE & LIMITS ---
  plan      PlanTier @default(FREE)
  credits   Int      @default(3)      // Tracks how many times they can use the platform
  
  // --- SUBSCRIPTION (Razorpay) ---
  subscriptionId     String?   // Razorpay Subscription ID
  subscriptionActive Boolean   @default(false)
  currentPeriodEnd   DateTime? // Expiry date for the plan

  // Relations
  machines     Machine[]
  reports      Report[]
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

// ==============================
// 3. MACHINE INVENTORY
// ==============================

model Machine {
  id            String   @id @default(cuid())
  name          String   // e.g. "CNC Lathe 01"
  type          String?  // e.g. "Hydraulic Press"
  modelNumber   String?
  installDate   DateTime?
  
  // Stores flexible technical details (Voltage, RPM, etc.)
  specifications Json?   
  
  // Relations
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  reports       Report[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
}

// ==============================
// 4. AI REPORTS (The Core Logic)
// ==============================

model Report {
  id              String   @id @default(cuid())
  
  // --- INPUT SOURCE ---
  type            SubmissionType @default(FILE_UPLOAD)
  
  // If FILE: We only store the Link (not the file itself)
  fileUrl         String?  
  fileName        String?

  // If MANUAL: We store the text the user typed
  manualInputText String?  @db.Text 
  
  // --- AI RESULTS ---
  status          ProcessingStatus @default(PENDING)
  
  healthScore     Int?     // 0-100 Score
  riskLevel       RiskLevel?
  
  // The detailed analysis text generated by Gemini
  summary         String?  @db.Text
  
  // Actionable steps stored as a list (JSON)
  recommendations Json?
  
  // Store the raw JSON from AI for debugging/improvements
  rawAiResponse   Json?
  
  // Usage Tracking: How many credits did this cost?
  costInCredits   Int      @default(1)

  // Relations
  machineId       String
  machine         Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User     @relation(fields: [userId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([machineId])
  @@index([userId])
}

// ==============================
// 5. PAYMENTS (Razorpay)
// ==============================

model Transaction {
  id              String   @id @default(cuid())
  amount          Int      // Amount in lowest currency unit (e.g. Paise)
  planType        PlanTier? 
  creditsAdded    Int      // 0 if subscription, >0 if credit pack
  
  razorpayOrderId   String? @unique
  razorpayPaymentId String?
  status            String  // "created", "paid", "failed"

  userId          String
  user            User     @relation(fields: [userId], references: [id])

  createdAt       DateTime @default(now())
}